/*! Around-Me 2014-07-19 */
!function(){"use strict";var a={VERSION:1,DEBUG:!0,$:function(a){return document.getElementById(a)},addevent:function(a,b,c){window.addEventListener?a.addEventListener(b,c,!1):window.attachEvent&&(r=a.attachEvent("on"+b,c))}};window.App=a,a.addevent(window,"load",function(b){a.init(b),a.initSelect(),a.paginator.init(b)},!1)}(),function(){"use strict";App.Log=function(){if(App.DEBUG){var a=Array.prototype.slice.call(arguments),b="["+(new Date).toString("HH:mm:ss.SSS")+"]";a.unshift(b),console&&console.log.apply(console,a)}}}(),function(){"use strict";function a(a,b,d){var e=c();if(e){var f=d?"POST":"GET";e.open(f,a,!0),d&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){4==e.readyState&&(200==e.status||304==e.status)&&b(e)},4!=e.readyState&&e.send(d)}}function b(){return[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]}function c(){for(var a=!1,c=b(),d=0;d<c.length;d++){try{a=c[d]()}catch(e){continue}break}return a}var d=function(){return JSON.stringify({query:{match_all:{}},facets:{tag:{terms:{field:"type",size:100}}}})},e=function(a,b,c){App.Log(a+" : "+b);var d={sort:[{_geo_distance:{location:{lat:a,lon:b},order:"asc",unit:"km"}}],query:{filtered:{query:{match_all:{}},filter:{geo_distance:{distance:c+"km",location:{lat:a,lon:b}}}}}},e=App.$("ddlPlaces");if(e.selectedIndex>-1){var f=e.options[e.selectedIndex].value;"any"!==f&&(d.query.filtered.query={bool:{should:[{term:{type:f}}]}})}return JSON.stringify(d)},f=App.$,g=function(a){if(a.responseText){var b=JSON.parse(a.responseText);App.paginator.configure(b.hits.total);for(var c=b.hits.hits,d="<ol class='resultList'>",e=0;e<c.length;e++){var g=c[e],i=g._source.location;d+=h(g),App.AddMarker(i,g._source.name,g._id)}d+="</ol>",f("lhc").innerHTML=d}},h=function(a){return App.Log(a),"<li id='"+a._id+"' onclick='App.ShowPopup(this)'>"+a._source.name+" - "+a._source.type+"</li>"},i=function(){App.ClearMarker(),f("lhc").innerHTML="";var b=App.getRadious(),c=App.paginator.getUri(),d=App.getSearchCenter(),h=e(d.lat,d.lng,b);a(c,g,h)},j=function(b,c,d){var e="/elastic/places/place/"+b;a(e,function(a){var b=JSON.parse(a.responseText),e=[];e.push("<table cellspacing='0'><thead><th>Attribute</th><th>Value</th></thead>");var f=b._source;for(var g in f)"location"==g?(e.push("<tr><td>Latitude</td><td>"+f[g].lat+"</td></tr>"),e.push("<tr><td>Longitude</td><td>"+f[g].lon+"</td></tr>")):e.push("<tr><td>"+g+"</td><td>"+f[g]+"</td></tr>");e.push("</table>"),c(d,"<b>"+e.join("")+"</b>")})},k=function(b){var c="/elastic/places/_search",e=d();a(c,b,e)};App.getDistinctPlaces=k,App.fetchData=i,App.fetchDetails=j}(),function(){"use strict";var a=App.$,b=a("pageInfo"),c=App.fetchData,d={totalPages:0,currentPage:0,pagesize:100,totalResults:0,uri:"http://localhost/elastic/places/_search?size={0}&from={1}",init:function(){App.addevent(a("pagePrev"),"click",function(a){return a.stopPropagation(),d.currentPage>1&&(d.currentPage--,c()),!1}),App.addevent(a("pageNext"),"click",function(a){return a.stopPropagation(),d.currentPage<d.totalPages&&(d.currentPage++,c()),!1}),App.fetchData()},getUri:function(){var a=0;return d.currentPage>1&&(a=(d.currentPage-1)*d.pagesize),d.uri.replace("{0}",d.pagesize).replace("{1}",a)},configure:function(a){d.totalPages=Math.ceil(a/d.pagesize),d.totalResults=a,a>0&&0==d.currentPage&&(d.currentPage=1),d.setUI()},reset:function(){d.totalPages=0,d.currentPage=0,d.setUI()},setUI:function(){if(d.totalPages<1)b.innerHTML=" No results found";else{var a=(d.currentPage-1)*d.pagesize+1,c=a+d.pagesize-1;c>d.totalResults&&(c=d.totalResults),b.innerHTML="Displaying "+a+" - "+c+" of "+d.totalResults}}};App.paginator=d}(),function(){"use strict";var a=function(){App.getDistinctPlaces(b);var a=App.$("ddlPlaces");App.addevent(a,"change",function(){var a=this.selectedIndex,b=this.options[a].value;App.Log(b),App.paginator.reset(),"any"!==b?App.fetchData("?q=type:"+b):App.fetchData()})},b=function(a){var b=JSON.parse(a.responseText),c=b.facets.tag.terms;App.Log(c);var d=[];d.push("<option value='any'>---ANY---</option>");for(var e=0;e<c.length;e++){var f=c[e].term;d.push("<option value='"+f+"'>"+f.replace(/_/g," ")+"</option>")}App.$("ddlPlaces").innerHTML=d.join("")},c=new google.maps.places.SearchBox(App.$("txtSearch"));google.maps.event.addListener(c,"places_changed",function(){var a=c.getPlaces(),b=a[0],d=b.geometry.location,e=d.lat(),f=d.lng();App.centerMaptorequestedCenter(e,f)}),App.initSelect=a}(),function(){"use strict";var a,b,c,d,e,f,g=[],h={zoom:14,center:new google.maps.LatLng(51.5286416,-.1015987),disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE},scrollwheel:!0,draggable:!0,panControl:!0,scaleControl:!0,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},i={strokeColor:"#FF0000",strokeOpacity:.3,strokeWeight:8,fillColor:"#fff",fillOpacity:0,map:null,center:null,radius:0},j={url:"img/marker.png",size:new google.maps.Size(26,41),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(18,41)},k=App.$("milesRange");App.getRadious=function(){return Number(k.value)},App.getSearchCenter=function(){return{lat:c.getPosition().lat(),lng:c.getPosition().lng()}},App.AddMarker=function(b,c,d){var e=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lon),map:a,id:d,icon:j,title:c});google.maps.event.addListener(e,"click",function(){App.fetchDetails(e.id,n,e)}),g.push(e)},App.ClearMarker=function(){q()},App.ShowPopup=function(b){var c=b.id;App.Log(c);for(var d in g)if(g[d].id===c)return new google.maps.event.trigger(g[d],"click"),a.setCenter(g[d].getPosition()),void a.setZoom(16)};var l=App.$("txtRadious"),m=function(){a.fitBounds(b.getBounds()),App.paginator.reset(),App.fetchData()},n=function(b,c){d.setContent(c),d.open(a,b)};App.changeSearchRadious=function(){var a=k.value;l.innerHTML=a+" kilometers",b.setOptions({radius:1e3*a})};var o=function(){var a=c.getPosition();b.setOptions({center:a})},p=function(){c.setAnimation(null!=c.getAnimation()?null:google.maps.Animation.BOUNCE)},q=function(){if(g){for(var a in g)g[a].setMap(null);g.length=0}d.setMap(null)},r=function(){clearTimeout(f),f=setTimeout(function(){a.setCenter(c.getPosition()),App.paginator.reset(),App.fetchData()},1e3)},s=function(b,d){c.position=new google.maps.LatLng(b,d),a.setCenter(c.getPosition()),o(),m()};App.initializeMap=function(){a=new google.maps.Map(App.$("rhc"),h),i.map=a,i.center=a.center,e=App.$("pageInfo"),b=new google.maps.Circle(i);var f=new google.maps.MarkerImage("img/crosshair.png",null,new google.maps.Point(0,0),new google.maps.Point(16,16));c=new google.maps.Marker({map:a,draggable:!0,position:a.center,icon:f}),d=new google.maps.InfoWindow({content:""}),google.maps.event.addListener(c,"click",p),google.maps.event.addListener(c,"drag",o),google.maps.event.addListener(c,"dragend",r),App.addevent(k,"mouseup",m),App.centerMaptorequestedCenter=s,App.changeSearchRadious()}}(),function(){"use strict";App.init=function(){App.Log("started..."),App.initializeMap()}}();